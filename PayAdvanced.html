<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gugu's Kitchen - Payment</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      :root {
        --primary: #ff7b00;
        --secondary: #333;
        --accent: #ffd166;
        --light: #f8f9fa;
        --dark: #343a40;
        --success: #28a745;
        --danger: #dc3545;
        --warning: #ffc107;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f5f5;
        color: #333;
        line-height: 1.6;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }

      header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
      }

      h1,
      h2,
      h3 {
        margin-bottom: 15px;
        color: var(--primary);
      }

      .order-summary {
        background-color: var(--light);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .order-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .detail-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }

      .payment-methods {
        margin-bottom: 20px;
      }

      .payment-option {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .payment-option:hover {
        border-color: var(--primary);
        background-color: #fff9f0;
      }

      .payment-option input {
        margin-right: 10px;
      }

      .payment-option label {
        cursor: pointer;
        flex-grow: 1;
      }

      .btn {
        display: block;
        width: 100%;
        padding: 12px;
        background-color: var(--success);
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 1.1rem;
        cursor: pointer;
        margin-top: 20px;
        transition: background-color 0.3s;
      }

      .btn:hover {
        background-color: #218838;
      }

      .btn-secondary {
        background-color: var(--secondary);
      }

      .btn-secondary:hover {
        background-color: #555;
      }

      .btn-danger {
        background-color: var(--danger);
      }

      .btn-danger:hover {
        background-color: #bd2130;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 4px;
        z-index: 1000;
        display: none;
        color: white;
      }

      .notification.success {
        background-color: var(--success);
        display: block;
      }

      .notification.error {
        background-color: var(--danger);
        display: block;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .order-items {
        margin-top: 20px;
      }

      .order-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
      }

      .inventory-update {
        margin-top: 5px;
        font-size: 0.85em;
        color: #666;
      }

      .debug-info {
        margin-top: 30px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid var(--primary);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Gugu's Kitchen</h1>
        <p>Complete Your Payment</p>
      </header>

      <div class="order-summary">
        <h2>Order Summary</h2>
        <div class="order-details">
          <div class="detail-item">
            <span>Order ID:</span>
            <span id="orderId">Loading...</span>
          </div>
          <div class="detail-item">
            <span>Order Total:</span>
            <span id="orderTotal">R0.00</span>
          </div>
          <div class="detail-item">
            <span>Status:</span>
            <span id="orderStatus">Loading...</span>
          </div>
          <div class="detail-item">
            <span>Order Date:</span>
            <span id="orderDate">Loading...</span>
          </div>
        </div>

        <div class="order-items">
          <h3>Items in this order:</h3>
          <div id="orderItemsList">
            <!-- Order items will be populated here -->
          </div>
        </div>
      </div>

      <div class="payment-methods">
        <h2>Select Payment Method</h2>
        <div class="payment-option">
          <input
            type="radio"
            id="cash"
            name="paymentMethod"
            value="cash"
            checked
          />
          <label for="cash">Cash</label>
        </div>
        <div class="payment-option">
          <input type="radio" id="card" name="paymentMethod" value="card" />
          <label for="card">Credit/Debit Card</label>
        </div>
        <div class="payment-option">
          <input type="radio" id="online" name="paymentMethod" value="online" />
          <label for="online">Online Payment</label>
        </div>
      </div>

      <button id="payBtn" class="btn">Complete Payment</button>
      <!-- <button id="orderAgainBtn" class="btn btn-secondary">Order Again</button> -->
      <button id="logoutBtn" class="btn btn-danger">Logout</button>

      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Processing payment and updating inventory...</p>
      </div>

      <!-- <div class="debug-info">
        <h3>Database Schema Detected:</h3>
        <p>âœ“ Inventory table with transaction tracking</p>
        <p>âœ“ Menu items with categories</p>
        <p>âœ“ Orders and order items</p>
        <p>âœ“ Payments tracking</p>
        <p>âœ“ User authentication</p>
      </div>
    </div> -->

    <div class="notification" id="notification"></div>

    <script>
      // =============================
      // Supabase Initialization
      // =============================
      const SUPABASE_URL = "https://dqnmbayimyiuqfzdalox.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxbm1iYXlpbXlpdXFmemRhbG94Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5OTIwOTYsImV4cCI6MjA3MDU2ODA5Nn0.XPsThMYTgbUX4JU743QhdDwPvVMcPZ1_3OBvMMGW5o4";
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // =============================
      // Global Variables
      // =============================
      let latestOrder = null;
      let orderItems = [];
      let inventoryItems = [];
      let currentUser = null;

      // =============================
      // Fetch Latest Order
      // =============================
      async function fetchLatestOrder(userId) {
        try {
          const { data, error } = await supabase
            .from("orders")
            .select("*")
            .eq("user_id", userId)
            .order("created_at", { ascending: false })
            .limit(1);

          if (error) throw error;

          if (data && data.length > 0) {
            latestOrder = data[0];
            document.getElementById("orderId").textContent = latestOrder.id;
            document.getElementById(
              "orderTotal"
            ).textContent = `R${latestOrder.total.toFixed(2)}`;
            document.getElementById("orderStatus").textContent =
              latestOrder.status;
            document.getElementById("orderDate").textContent = new Date(
              latestOrder.created_at
            ).toLocaleString();

            // Fetch order items
            await fetchOrderItems(latestOrder.id);
          } else {
            document.getElementById("orderId").textContent = "No order found";
            document.getElementById("orderStatus").textContent = "N/A";
          }
        } catch (error) {
          console.error("Error fetching order:", error);
          showNotification("Error loading order details", "error");
        }
      }

      // =============================
      // Fetch Order Items
      // =============================
      async function fetchOrderItems(orderId) {
        try {
          const { data, error } = await supabase
            .from("order_items")
            .select(
              `
                        *,
                        menu:menu_id (*)
                    `
            )
            .eq("order_id", orderId);

          if (error) throw error;

          orderItems = data || [];
          displayOrderItems();
        } catch (error) {
          console.error("Error fetching order items:", error);
        }
      }

      // =============================
      // Display Order Items
      // =============================
      function displayOrderItems() {
        const container = document.getElementById("orderItemsList");
        container.innerHTML = "";

        orderItems.forEach((item) => {
          const div = document.createElement("div");
          div.className = "order-item";
          div.innerHTML = `
                    <span>${item.menu.name} (x${item.quantity})</span>
                    <span>R${(item.price * item.quantity).toFixed(2)}</span>
                `;
          container.appendChild(div);
        });
      }

      // =============================
      // Fetch Inventory Items
      // =============================
      async function fetchInventory() {
        try {
          const { data, error } = await supabase.from("inventory").select("*");

          if (error) throw error;

          inventoryItems = data || [];
          console.log("Inventory items loaded:", inventoryItems);
        } catch (error) {
          console.error("Error fetching inventory:", error);
          showNotification("Error loading inventory data", "error");
        }
      }

      // =============================
      // Extract Ingredients from Description
      // =============================
      function extractIngredients(description) {
        if (!description) return [];

        // Common ingredients to look for
        const commonIngredients = [
          "lettuce",
          "cucumber",
          "chips",
          "burger patty",
          "patty",
          "cheese",
          "sauces",
          "russian",
          "egg",
          "smoked ham",
          "pork rib patty",
          "Coke can",
          "Coca-cola",
          "water",
          "Sprite",
          "Stoney",
          "Vienna",
          "Tomato",
          "Atchar",
          "Polony",
          "burger",
          "pork rib",
          "gwinya",
          "bread",
          "bottle",
        ];

        const foundIngredients = [];
        const lowerDescription = description.toLowerCase();

        commonIngredients.forEach((ingredient) => {
          if (lowerDescription.includes(ingredient)) {
            foundIngredients.push(ingredient);
          }
        });

        return foundIngredients;
      }

      // =============================
      // Find Inventory Item by Name
      // =============================
      function findInventoryItem(ingredientName) {
        return inventoryItems.find((item) =>
          item.name.toLowerCase().includes(ingredientName.toLowerCase())
        );
      }

      // =============================
      // Check if item is a drink
      // =============================
      function isDrink(item) {
        return item.menu.category === "drinks";
      }

      // =============================
      // Record Inventory Transaction
      // =============================
      async function recordInventoryTransaction(
        inventoryId,
        adjustmentType,
        amount,
        previousQuantity,
        newQuantity,
        notes = ""
      ) {
        try {
          const { data, error } = await supabase
            .from("inventory_transactions")
            .insert([
              {
                inventory_id: inventoryId,
                user_id: currentUser.id,
                adjustment_type: adjustmentType,
                amount: amount,
                previous_quantity: previousQuantity,
                new_quantity: newQuantity,
                notes: notes,
                created_at: new Date().toISOString(),
              },
            ]);

          if (error) throw error;
          return true;
        } catch (error) {
          console.error("Error recording inventory transaction:", error);
          return false;
        }
      }

      // =============================
      // Deduct Ingredients from Inventory
      // =============================
      async function deductIngredientsFromInventory() {
        let allSuccessful = true;
        const deductedItems = [];

        try {
          // Process each order item
          for (const item of orderItems) {
            // Skip drinks as they don't have ingredients to deduct
            if (isDrink(item)) {
              console.log(
                `Skipping inventory deduction for drink: ${item.menu.name}`
              );
              continue;
            }

            const ingredients = extractIngredients(item.menu.description);

            if (ingredients.length === 0) {
              console.log(`No ingredients found for: ${item.menu.name}`);
              continue;
            }

            // Deduct each ingredient from inventory
            for (const ingredient of ingredients) {
              const inventoryItem = findInventoryItem(ingredient);

              if (inventoryItem) {
                // Deduct based on quantity (simplified: 1 unit per menu item)
                const deductionAmount = item.quantity;
                const previousQuantity = parseFloat(
                  inventoryItem.current_quantity
                );
                const newQuantity = Math.max(
                  0,
                  previousQuantity - deductionAmount
                );

                // Update inventory
                const { error: updateError } = await supabase
                  .from("inventory")
                  .update({
                    current_quantity: newQuantity,
                    last_updated: new Date().toISOString(),
                  })
                  .eq("id", inventoryItem.id);

                if (updateError) {
                  console.error(
                    `Error updating ${inventoryItem.name}:`,
                    updateError
                  );
                  allSuccessful = false;
                } else {
                  // Record transaction
                  const transactionRecorded = await recordInventoryTransaction(
                    inventoryItem.id,
                    "remove",
                    deductionAmount,
                    previousQuantity,
                    newQuantity,
                    `Deducted for order #${latestOrder.id}, item: ${item.menu.name}`
                  );

                  if (!transactionRecorded) {
                    console.error(
                      `Failed to record transaction for ${inventoryItem.name}`
                    );
                    allSuccessful = false;
                  } else {
                    console.log(
                      `Deducted ${deductionAmount} ${inventoryItem.name} from inventory`
                    );
                    deductedItems.push({
                      name: inventoryItem.name,
                      amount: deductionAmount,
                      newQuantity: newQuantity,
                    });
                  }
                }
              }
            }
          }

          return { success: allSuccessful, deductedItems };
        } catch (error) {
          console.error("Error deducting inventory:", error);
          return { success: false, deductedItems: [] };
        }
      }

      // =============================
      // Handle Payment
      // =============================
      document.getElementById("payBtn").addEventListener("click", async () => {
        if (!latestOrder) {
          showNotification("No order found to pay for", "error");
          return;
        }

        if (latestOrder.status !== "pending") {
          showNotification("This order has already been processed", "error");
          return;
        }

        const method = document.querySelector(
          'input[name="paymentMethod"]:checked'
        ).value;

        // Show loading state
        document.getElementById("loading").style.display = "block";
        document.getElementById("payBtn").disabled = true;

        try {
          // 1. Create payment record
          const payment = {
            order_id: latestOrder.id,
            amount: latestOrder.total,
            method: method,
            status: "paid",
            created_at: new Date().toISOString(),
          };

          const { data: paymentData, error: paymentError } = await supabase
            .from("payments")
            .insert([payment])
            .select();

          if (paymentError) throw paymentError;

          // 2. Update order status to paid
          const { error: orderError } = await supabase
            .from("orders")
            .update({ status: "paid" })
            .eq("id", latestOrder.id);

          if (orderError) throw orderError;

          // 3. Deduct ingredients from inventory (skips drinks automatically)
          const inventoryResult = await deductIngredientsFromInventory();

          // 4. Show success message
          if (inventoryResult.success) {
            showNotification(
              "Payment successful! Inventory updated.",
              "success"
            );
          } else {
            showNotification(
              "Payment processed but there were issues with inventory update.",
              "error"
            );
          }

          // 5. Update UI
          document.getElementById("orderStatus").textContent = "paid";
          latestOrder.status = "paid";

          console.log("âœ… Payment processed");
          if (inventoryResult.deductedItems.length > 0) {
            console.log(
              "ðŸ“¦ Inventory items deducted:",
              inventoryResult.deductedItems
            );
          }
        } catch (error) {
          console.error("Error processing payment:", error);
          showNotification("Payment failed: " + error.message, "error");
        } finally {
          // Hide loading state
          document.getElementById("loading").style.display = "none";
          document.getElementById("payBtn").disabled = false;
        }
      });

      // =============================
      // Show Notification
      // =============================
      function showNotification(message, type) {
        const notification = document.getElementById("notification");
        notification.textContent = message;
        notification.className = `notification ${type}`;

        setTimeout(() => {
          notification.className = "notification";
        }, 3000);
      }

      // =============================
      // Initialize Page
      // =============================
      async function initialize() {
        // Get user from localStorage
        const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
        currentUser = loggedInUser;

        if (!currentUser || !currentUser.id) {
          showNotification("Please log in to view your orders", "error");
          return;
        }

        // Fetch data
        await fetchInventory();
        await fetchLatestOrder(currentUser.id);

        // Set up event listeners for buttons
        document
          .getElementById("orderAgainBtn")
          .addEventListener("click", () => {
            window.location.href = "menu.html";
          });

        document.getElementById("logoutBtn").addEventListener("click", () => {
          localStorage.removeItem("loggedInUser");
          window.location.href = "index.html";
        });
      }

      // Start initialization when page loads
      document.addEventListener("DOMContentLoaded", initialize);
    </script>
  </body>
</html>
