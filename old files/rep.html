<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gugu's Kitchen - Reports Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --primary: #ff7b00;
        --secondary: #333;
        --accent: #ffd166;
        --light: #f8f9fa;
        --dark: #343a40;
        --success: #28a745;
        --danger: #dc3545;
        --warning: #ffc107;
        --info: #17a2b8;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f5f5;
        color: #333;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        background-color: var(--primary);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      h1,
      h2,
      h3,
      h4 {
        margin-bottom: 15px;
        color: var(--primary);
      }

      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }

      .stat-card {
        text-align: center;
        padding: 15px;
      }

      .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--primary);
        margin: 10px 0;
      }

      .stat-label {
        font-size: 0.9rem;
        color: #666;
      }

      .filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
      }

      .filter-group label {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .filter-group select,
      .filter-group input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .btn {
        padding: 8px 16px;
        background-color: var(--primary);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .btn:hover {
        background-color: #e06a00;
      }

      .btn-secondary {
        background-color: var(--secondary);
      }

      .btn-secondary:hover {
        background-color: #555;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      th {
        background-color: var(--light);
        font-weight: bold;
      }

      tr:hover {
        background-color: #f5f5f5;
      }

      .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 30px;
      }

      .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid #ddd;
      }

      .tab {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        border-bottom: 3px solid transparent;
      }

      .tab.active {
        border-bottom: 3px solid var(--primary);
        font-weight: bold;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 4px;
        z-index: 1000;
        display: none;
        color: white;
      }

      .notification.success {
        background-color: var(--success);
        display: block;
      }

      .notification.error {
        background-color: var(--danger);
        display: block;
      }

      .loading {
        text-align: center;
        padding: 20px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .low-stock {
        background-color: #fff3cd;
      }

      .out-of-stock {
        background-color: #f8d7da;
      }

      .chart-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      @media (max-width: 768px) {
        .chart-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Gugu's Kitchen - Reports Dashboard</h1>
        <div>
          <button class="btn" id="refreshBtn">Refresh Data</button>
          <button class="btn btn-secondary" id="backBtn">Back to Main</button>
        </div>
      </header>

      <div class="dashboard">
        <div class="card stat-card">
          <div class="stat-label">Today's Revenue</div>
          <div class="stat-value" id="todayRevenue">R0.00</div>
          <div class="stat-label" id="todayOrders">0 orders</div>
        </div>

        <div class="card stat-card">
          <div class="stat-label">This Month's Revenue</div>
          <div class="stat-value" id="monthRevenue">R0.00</div>
          <div class="stat-label" id="monthOrders">0 orders</div>
        </div>

        <div class="card stat-card">
          <div class="stat-label">Low Stock Items</div>
          <div class="stat-value" id="lowStockCount">0</div>
          <div class="stat-label">Need restocking</div>
        </div>

        <div class="card stat-card">
          <div class="stat-label">Total Customers</div>
          <div class="stat-value" id="customersCount">0</div>
          <div class="stat-label">Registered users</div>
        </div>
      </div>

      <div class="filters">
        <div class="filter-group">
          <label for="dateRange">Date Range</label>
          <select id="dateRange">
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="week">This Week</option>
            <option value="month" selected>This Month</option>
            <option value="quarter">This Quarter</option>
            <option value="year">This Year</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>

        <div class="filter-group" id="startDateGroup" style="display: none">
          <label for="startDate">Start Date</label>
          <input type="date" id="startDate" />
        </div>

        <div class="filter-group" id="endDateGroup" style="display: none">
          <label for="endDate">End Date</label>
          <input type="date" id="endDate" />
        </div>

        <div class="filter-group">
          <label for="reportType">Report Type</label>
          <select id="reportType">
            <option value="sales">Sales Report</option>
            <option value="inventory">Inventory Report</option>
            <option value="popular">Popular Items</option>
            <option value="transactions">Inventory Transactions</option>
          </select>
        </div>

        <div class="filter-group">
          <label style="visibility: hidden">Apply</label>
          <button class="btn" id="applyFilters">Apply Filters</button>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="charts">Charts</button>
        <button class="tab" data-tab="data">Data Tables</button>
        <button class="tab" data-tab="inventory">Inventory</button>
      </div>

      <div class="tab-content active" id="chartsTab">
        <div class="chart-row">
          <div class="card">
            <h3>Revenue Trends</h3>
            <div class="chart-container">
              <canvas id="revenueChart"></canvas>
            </div>
          </div>

          <div class="card">
            <h3>User Types</h3>
            <div class="chart-container">
              <canvas id="userTypesChart"></canvas>
            </div>
          </div>
        </div>

        <div class="chart-row">
          <div class="card">
            <h3>Top Selling Menu Items</h3>
            <div class="chart-container">
              <canvas id="popularItemsChart"></canvas>
            </div>
          </div>

          <div class="card">
            <h3>Payment Methods</h3>
            <div class="chart-container">
              <canvas id="paymentMethodsChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content" id="dataTab">
        <div class="card">
          <h3>Sales Data</h3>
          <div class="table-responsive">
            <table id="salesTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Payment Method</th>
                </tr>
              </thead>
              <tbody>
                <!-- Sales data will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="tab-content" id="inventoryTab">
        <div class="card">
          <h3>Inventory Status</h3>
          <div class="table-responsive">
            <table id="inventoryTable">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Current Stock</th>
                  <th>Unit</th>
                  <th>Threshold</th>
                  <th>Status</th>
                  <th>Last Updated</th>
                </tr>
              </thead>
              <tbody>
                <!-- Inventory data will be populated here -->
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3>Inventory Transactions</h3>
          <div class="table-responsive">
            <table id="transactionsTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Item</th>
                  <th>User</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Previous Qty</th>
                  <th>New Qty</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                <!-- Transaction data will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
      // =============================
      // Supabase Initialization
      // =============================
      const SUPABASE_URL = "https://dqnmbayimyiuqfzdalox.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxbm1iYXlpbXlpdXFmemRhbG94Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5OTIwOTYsImV4cCI6MjA3MDU2ODA5Nn0.XPsThMYTgbUX4JU743QhdDwPvVMcPZ1_3OBvMMGW5o4";
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // =============================
      // Global Variables
      // =============================
      let revenueChart = null;
      let popularItemsChart = null;
      let userTypesChart = null;
      let paymentMethodsChart = null;
      let currentUser = null;

      // =============================
      // Initialize Page
      // =============================
      document.addEventListener("DOMContentLoaded", function () {
        initializePage();
        setupEventListeners();
      });

      // =============================
      // Setup Event Listeners
      // =============================
      function setupEventListeners() {
        // Tab navigation
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.addEventListener("click", function () {
            document
              .querySelectorAll(".tab")
              .forEach((t) => t.classList.remove("active"));
            document
              .querySelectorAll(".tab-content")
              .forEach((c) => c.classList.remove("active"));

            this.classList.add("active");
            document
              .getElementById(this.getAttribute("data-tab") + "Tab")
              .classList.add("active");
          });
        });

        // Date range filter
        document
          .getElementById("dateRange")
          .addEventListener("change", function () {
            const isCustom = this.value === "custom";
            document.getElementById("startDateGroup").style.display = isCustom
              ? "block"
              : "none";
            document.getElementById("endDateGroup").style.display = isCustom
              ? "block"
              : "none";
          });

        // Apply filters
        document
          .getElementById("applyFilters")
          .addEventListener("click", function () {
            loadData();
          });

        // Refresh button
        document
          .getElementById("refreshBtn")
          .addEventListener("click", function () {
            loadData();
          });

        // Back button
        document
          .getElementById("backBtn")
          .addEventListener("click", function () {
            window.location.href = "menu.html";
          });
      }

      // =============================
      // Initialize Page
      // =============================
      function initializePage() {
        // Get user from localStorage
        const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
        currentUser = loggedInUser;

        if (!currentUser || !currentUser.id) {
          showNotification("Please log in to access reports", "error");
          return;
        }

        // Load data
        loadData();
      }

      // =============================
      // Load All Data
      // =============================
      async function loadData() {
        try {
          await Promise.all([
            loadDashboardStats(),
            loadSalesData(),
            loadInventoryData(),
            loadTransactionData(),
            loadChartsData(),
          ]);
        } catch (error) {
          console.error("Error loading data:", error);
          showNotification("Error loading report data", "error");
        }
      }

      // =============================
      // Load Dashboard Statistics
      // =============================
      async function loadDashboardStats() {
        try {
          // Get date range
          const dateRange = getDateRange();

          // Get today's payments (completed orders)
          const { data: todayPayments, error: todayError } = await supabase
            .from("payments")
            .select("amount, created_at, orders!inner(status)")
            .gte("created_at", dateRange.todayStart)
            .lte("created_at", dateRange.todayEnd)
            .eq("orders.status", "paid");

          if (todayError) throw todayError;

          const todayRevenue = todayPayments.reduce(
            (sum, payment) => sum + parseFloat(payment.amount),
            0
          );
          const todayOrders = todayPayments.length;

          document.getElementById(
            "todayRevenue"
          ).textContent = `R${todayRevenue.toFixed(2)}`;
          document.getElementById(
            "todayOrders"
          ).textContent = `${todayOrders} orders`;

          // Get this month's payments (completed orders)
          const { data: monthPayments, error: monthError } = await supabase
            .from("payments")
            .select("amount, created_at, orders!inner(status)")
            .gte("created_at", dateRange.monthStart)
            .lte("created_at", dateRange.monthEnd)
            .eq("orders.status", "paid");

          if (monthError) throw monthError;

          const monthRevenue = monthPayments.reduce(
            (sum, payment) => sum + parseFloat(payment.amount),
            0
          );
          const monthOrders = monthPayments.length;

          document.getElementById(
            "monthRevenue"
          ).textContent = `R${monthRevenue.toFixed(2)}`;
          document.getElementById(
            "monthOrders"
          ).textContent = `${monthOrders} orders`;

          // Low stock items
          const { data: inventoryData, error: inventoryError } = await supabase
            .from("inventory")
            .select("*");

          if (inventoryError) throw inventoryError;

          const lowStockItems = inventoryData.filter(
            (item) => item.current_quantity <= item.market_threshold
          );

          document.getElementById("lowStockCount").textContent =
            lowStockItems.length;

          // Customer count
          const { data: usersData, error: usersError } = await supabase
            .from("users")
            .select("id, role")
            .eq("role", "customer");

          if (usersError) throw usersError;

          document.getElementById("customersCount").textContent =
            usersData.length;
        } catch (error) {
          console.error("Error loading dashboard stats:", error);
          throw error;
        }
      }

      // =============================
      // Load Sales Data
      // =============================
      async function loadSalesData() {
        try {
          const dateRange = getDateRange();

          const { data: ordersData, error: ordersError } = await supabase
            .from("orders")
            .select(
              `
                        id,
                        total,
                        status,
                        created_at,
                        user_id,
                        users (username)
                    `
            )
            .gte("created_at", dateRange.start)
            .lte("created_at", dateRange.end)
            .order("created_at", { ascending: false });

          if (ordersError) throw ordersError;

          const { data: paymentsData, error: paymentsError } = await supabase
            .from("payments")
            .select("order_id, method")
            .in(
              "order_id",
              ordersData.map((order) => order.id)
            );

          if (paymentsError) throw paymentsError;

          // Create a map of order_id to payment method
          const paymentMap = {};
          paymentsData.forEach((payment) => {
            paymentMap[payment.order_id] = payment.method;
          });

          // Populate sales table
          const salesTable = document
            .getElementById("salesTable")
            .querySelector("tbody");
          salesTable.innerHTML = "";

          ordersData.forEach((order) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                        <td>${new Date(
                          order.created_at
                        ).toLocaleDateString()}</td>
                        <td>${order.id}</td>
                        <td>${order.users?.username || "Guest"}</td>
                        <td>R${parseFloat(order.total).toFixed(2)}</td>
                        <td>${order.status}</td>
                        <td>${paymentMap[order.id] || "N/A"}</td>
                    `;
            salesTable.appendChild(row);
          });
        } catch (error) {
          console.error("Error loading sales data:", error);
          throw error;
        }
      }

      // =============================
      // Load Inventory Data
      // =============================
      async function loadInventoryData() {
        try {
          const { data: inventoryData, error: inventoryError } = await supabase
            .from("inventory")
            .select("*")
            .order("name");

          if (inventoryError) throw inventoryError;

          // Populate inventory table
          const inventoryTable = document
            .getElementById("inventoryTable")
            .querySelector("tbody");
          inventoryTable.innerHTML = "";

          inventoryData.forEach((item) => {
            const isLowStock = item.current_quantity <= item.market_threshold;
            const isOutOfStock = item.current_quantity <= 0;

            const row = document.createElement("tr");
            if (isOutOfStock) {
              row.classList.add("out-of-stock");
            } else if (isLowStock) {
              row.classList.add("low-stock");
            }

            row.innerHTML = `
                        <td>${item.name}</td>
                        <td>${item.current_quantity}</td>
                        <td>${item.unit_of_measure}</td>
                        <td>${item.market_threshold}</td>
                        <td>${
                          isOutOfStock
                            ? "Out of Stock"
                            : isLowStock
                            ? "Low Stock"
                            : "In Stock"
                        }</td>
                        <td>${new Date(
                          item.last_updated
                        ).toLocaleDateString()}</td>
                    `;
            inventoryTable.appendChild(row);
          });
        } catch (error) {
          console.error("Error loading inventory data:", error);
          throw error;
        }
      }

      // =============================
      // Load Transaction Data
      // =============================
      async function loadTransactionData() {
        try {
          const dateRange = getDateRange();

          const { data: transactionsData, error: transactionsError } =
            await supabase
              .from("inventory_transactions")
              .select(
                `
                        *,
                        inventory (name),
                        users (username)
                    `
              )
              .gte("created_at", dateRange.start)
              .lte("created_at", dateRange.end)
              .order("created_at", { ascending: false });

          if (transactionsError) throw transactionsError;

          // Populate transactions table
          const transactionsTable = document
            .getElementById("transactionsTable")
            .querySelector("tbody");
          transactionsTable.innerHTML = "";

          transactionsData.forEach((transaction) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                        <td>${new Date(
                          transaction.created_at
                        ).toLocaleDateString()}</td>
                        <td>${transaction.inventory.name}</td>
                        <td>${transaction.users.username}</td>
                        <td>${transaction.adjustment_type}</td>
                        <td>${transaction.amount}</td>
                        <td>${transaction.previous_quantity}</td>
                        <td>${transaction.new_quantity}</td>
                        <td>${transaction.notes || ""}</td>
                    `;
            transactionsTable.appendChild(row);
          });
        } catch (error) {
          console.error("Error loading transaction data:", error);
          throw error;
        }
      }

      // =============================
      // Load Charts Data
      // =============================
      async function loadChartsData() {
        try {
          const dateRange = getDateRange();

          // Get orders for the date range
          const { data: ordersData, error: ordersError } = await supabase
            .from("orders")
            .select("id, total, created_at, status")
            .gte("created_at", dateRange.start)
            .lte("created_at", dateRange.end)
            .eq("status", "paid")
            .order("created_at");

          if (ordersError) throw ordersError;

          // Get payments for these orders
          const { data: paymentsData, error: paymentsError } = await supabase
            .from("payments")
            .select("order_id, amount, method")
            .in(
              "order_id",
              ordersData.map((order) => order.id)
            );

          if (paymentsError) throw paymentsError;

          // Group payments by date for revenue chart
          const paymentMap = {};
          paymentsData.forEach((payment) => {
            const order = ordersData.find((o) => o.id === payment.order_id);
            if (order) {
              const date = new Date(order.created_at).toLocaleDateString();
              if (!paymentMap[date]) {
                paymentMap[date] = 0;
              }
              paymentMap[date] += parseFloat(payment.amount);
            }
          });

          // Create revenue chart
          createRevenueChart(
            Object.keys(paymentMap),
            Object.values(paymentMap)
          );

          // Get user types data
          const { data: usersData, error: usersError } = await supabase
            .from("users")
            .select("role");

          if (usersError) throw usersError;

          // Count users by role
          const userRoles = {};
          usersData.forEach((user) => {
            if (!userRoles[user.role]) {
              userRoles[user.role] = 0;
            }
            userRoles[user.role]++;
          });

          // Create user types chart
          createUserTypesChart(
            Object.keys(userRoles),
            Object.values(userRoles)
          );

          // Get order items for popular items chart
          const { data: orderItemsData, error: orderItemsError } =
            await supabase
              .from("order_items")
              .select(
                `
                        quantity,
                        menu_id,
                        menu:menu_id (name)
                    `
              )
              .in(
                "order_id",
                ordersData.map((order) => order.id)
              );

          if (orderItemsError) throw orderItemsError;

          // Group items by quantity sold
          const itemsSold = {};
          orderItemsData.forEach((item) => {
            if (!itemsSold[item.menu.name]) {
              itemsSold[item.menu.name] = 0;
            }
            itemsSold[item.menu.name] += item.quantity;
          });

          // Sort by most popular
          const popularItems = Object.entries(itemsSold)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);

          // Create popular items chart
          createPopularItemsChart(
            popularItems.map((item) => item[0]),
            popularItems.map((item) => item[1])
          );

          // Count payment methods
          const paymentMethods = {};
          paymentsData.forEach((payment) => {
            if (!paymentMethods[payment.method]) {
              paymentMethods[payment.method] = 0;
            }
            paymentMethods[payment.method]++;
          });

          // Create payment methods chart
          createPaymentMethodsChart(
            Object.keys(paymentMethods),
            Object.values(paymentMethods)
          );
        } catch (error) {
          console.error("Error loading charts data:", error);
          throw error;
        }
      }

      // =============================
      // Create Revenue Chart
      // =============================
      function createRevenueChart(labels, data) {
        const ctx = document.getElementById("revenueChart").getContext("2d");

        // Destroy previous chart if it exists
        if (revenueChart) {
          revenueChart.destroy();
        }

        revenueChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Daily Revenue (R)",
                data: data,
                backgroundColor: "rgba(255, 123, 0, 0.2)",
                borderColor: "rgba(255, 123, 0, 1)",
                borderWidth: 2,
                tension: 0.3,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function (value) {
                    return "R" + value;
                  },
                },
              },
            },
          },
        });
      }

      // =============================
      // Create User Types Chart
      // =============================
      function createUserTypesChart(labels, data) {
        const ctx = document.getElementById("userTypesChart").getContext("2d");

        // Destroy previous chart if it exists
        if (userTypesChart) {
          userTypesChart.destroy();
        }

        userTypesChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: [
                  "rgba(255, 123, 0, 0.7)",
                  "rgba(40, 167, 69, 0.7)",
                  "rgba(23, 162, 184, 0.7)",
                  "rgba(108, 117, 125, 0.7)",
                ],
                borderColor: [
                  "rgba(255, 123, 0, 1)",
                  "rgba(40, 167, 69, 1)",
                  "rgba(23, 162, 184, 1)",
                  "rgba(108, 117, 125, 1)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });
      }

      // =============================
      // Create Popular Items Chart
      // =============================
      function createPopularItemsChart(labels, data) {
        const ctx = document
          .getElementById("popularItemsChart")
          .getContext("2d");

        // Destroy previous chart if it exists
        if (popularItemsChart) {
          popularItemsChart.destroy();
        }

        popularItemsChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Quantity Sold",
                data: data,
                backgroundColor: "rgba(40, 167, 69, 0.7)",
                borderColor: "rgba(40, 167, 69, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: "y",
            scales: {
              x: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      // =============================
      // Create Payment Methods Chart
      // =============================
      function createPaymentMethodsChart(labels, data) {
        const ctx = document
          .getElementById("paymentMethodsChart")
          .getContext("2d");

        // Destroy previous chart if it exists
        if (paymentMethodsChart) {
          paymentMethodsChart.destroy();
        }

        paymentMethodsChart = new Chart(ctx, {
          type: "pie",
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: [
                  "rgba(255, 193, 7, 0.7)",
                  "rgba(23, 162, 184, 0.7)",
                  "rgba(40, 167, 69, 0.7)",
                  "rgba(108, 117, 125, 0.7)",
                ],
                borderColor: [
                  "rgba(255, 193, 7, 1)",
                  "rgba(23, 162, 184, 1)",
                  "rgba(40, 167, 69, 1)",
                  "rgba(108, 117, 125, 1)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });
      }

      // =============================
      // Get Date Range Based on Filter
      // =============================
      function getDateRange() {
        const now = new Date();
        const range = document.getElementById("dateRange").value;

        let startDate, endDate;

        switch (range) {
          case "today":
            startDate = new Date(
              now.getFullYear(),
              now.getMonth(),
              now.getDate()
            );
            endDate = new Date(
              now.getFullYear(),
              now.getMonth(),
              now.getDate(),
              23,
              59,
              59
            );
            break;
          case "yesterday":
            startDate = new Date(
              now.getFullYear(),
              now.getMonth(),
              now.getDate() - 1
            );
            endDate = new Date(
              now.getFullYear(),
              now.getMonth(),
              now.getDate() - 1,
              23,
              59,
              59
            );
            break;
          case "week":
            startDate = new Date(
              now.getFullYear(),
              now.getMonth(),
              now.getDate() - now.getDay()
            );
            endDate = new Date(
              now.getFullYear(),
              now.getMonth(),
              now.getDate() - now.getDay() + 6,
              23,
              59,
              59
            );
            break;
          case "month":
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = new Date(
              now.getFullYear(),
              now.getMonth() + 1,
              0,
              23,
              59,
              59
            );
            break;
          case "quarter":
            const quarter = Math.floor(now.getMonth() / 3);
            startDate = new Date(now.getFullYear(), quarter * 3, 1);
            endDate = new Date(
              now.getFullYear(),
              quarter * 3 + 3,
              0,
              23,
              59,
              59
            );
            break;
          case "year":
            startDate = new Date(now.getFullYear(), 0, 1);
            endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
            break;
          case "custom":
            startDate = new Date(document.getElementById("startDate").value);
            endDate = new Date(document.getElementById("endDate").value);
            endDate.setHours(23, 59, 59);
            break;
          default:
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = new Date(
              now.getFullYear(),
              now.getMonth() + 1,
              0,
              23,
              59,
              59
            );
        }

        // For dashboard stats
        const todayStart = new Date(
          now.getFullYear(),
          now.getMonth(),
          now.getDate()
        );
        const todayEnd = new Date(
          now.getFullYear(),
          now.getMonth(),
          now.getDate(),
          23,
          59,
          59
        );
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const monthEnd = new Date(
          now.getFullYear(),
          now.getMonth() + 1,
          0,
          23,
          59,
          59
        );

        return {
          start: startDate.toISOString(),
          end: endDate.toISOString(),
          todayStart: todayStart.toISOString(),
          todayEnd: todayEnd.toISOString(),
          monthStart: monthStart.toISOString(),
          monthEnd: monthEnd.toISOString(),
        };
      }

      // =============================
      // Show Notification
      // =============================
      function showNotification(message, type) {
        const notification = document.getElementById("notification");
        notification.textContent = message;
        notification.className = `notification ${type}`;

        setTimeout(() => {
          notification.className = "notification";
        }, 3000);
      }
    </script>
  </body>
</html>
